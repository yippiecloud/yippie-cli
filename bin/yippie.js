#!/usr/bin/env node
var z=Object.create;var p=Object.defineProperty,F=Object.defineProperties,_=Object.getOwnPropertyDescriptor,k=Object.getOwnPropertyDescriptors,A=Object.getOwnPropertyNames,f=Object.getOwnPropertySymbols,R=Object.getPrototypeOf,I=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable;var P=(e,o,n)=>o in e?p(e,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[o]=n,w=(e,o)=>{for(var n in o||(o={}))I.call(o,n)&&P(e,n,o[n]);if(f)for(var n of f(o))$.call(o,n)&&P(e,n,o[n]);return e},v=(e,o)=>F(e,k(o)),B=e=>p(e,"__esModule",{value:!0});var x=(e,o,n)=>{if(o&&typeof o=="object"||typeof o=="function")for(let i of A(o))!I.call(e,i)&&i!=="default"&&p(e,i,{get:()=>o[i],enumerable:!(n=_(o,i))||n.enumerable});return e},s=e=>x(B(p(e!=null?z(R(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e);var d=s(require("path")),S=s(require("dotenv")),U=s(require("fs")),t=s(require("aws-sdk")),r=s(require("amazon-cognito-identity-js")),m=s(require("command-line-args")),b=s(require("command-line-usage")),h=s(require("adm-zip"));var E="1.0.12";var g=[{name:"folder",alias:"f",type:String,defaultOption:!0,description:"Folder to deploy."},{name:"username",alias:"u",type:String,description:"Your yippie cloud username."},{name:"password",alias:"p",type:String,description:"Your yippie cloud password."},{name:"help",alias:"h",type:Boolean,description:"Display this usage guide."},{name:"verbose",alias:"v",type:Boolean,description:"Enable verbose outputs."}],u=(0,m.default)(g);if(u.help){let e=(0,b.default)([{header:"Usage",content:"yippie example"},{header:"Options",optionList:g},{content:"Project home: {underline https://www.yippie.cloud}"}]);console.log(e)}var{folder:l,verbose:K=!1}=(0,m.default)(g),M="5brts50g06t59npkbv8t3r2tva",D="yippiecloud-artifacts",L="eu-central-1",W="eu-central-1:b149ff98-8ae0-4157-b245-de1a8f8c2461",O="eu-central-1_zHXNt56dU",Z="yippiecloud-artifact-deployment-function";(0,S.config)();var a=process.env.YIPPIE_USERNAME||u.username,N=process.env.YIPPIE_PASSWORD||u.password;a||(console.error("Username is missing"),process.exit(1));N||(console.error("Password is missing"),process.exit(1));var G=new r.CognitoUserPool({ClientId:M,UserPoolId:O}),q=new r.CognitoUser({Pool:G,Username:a}),H=new r.AuthenticationDetails({Username:a,Password:N});q.authenticateUser(H,{onFailure:e=>{console.error(e.message)},onSuccess:e=>{t.default.config.update({maxRetries:0,httpOptions:{timeout:6e6,connectTimeout:6e6},region:L,credentials:new t.default.CognitoIdentityCredentials({IdentityPoolId:W,Logins:{[`cognito-idp.${L}.amazonaws.com/${O}`]:e.getIdToken().getJwtToken()}})}),t.default.config.credentials.refresh(async o=>{if(console.log(`Yippie cloud CLI v${E}`),o)return console.error(o.message);console.log("Login successfully!");let n=new t.default.S3,i=new t.default.Lambda;try{console.log("Zipping file(s) ...");let c=new h.default;c.addLocalFolder((0,d.join)(process.cwd(),l)),console.log("Uploading file ..."),await n.upload({Bucket:D,Key:`${a}/${l}.zip`,Body:c.toBuffer()}).promise(),console.log("Deploying project (up to 5 minutes) ...");let T=(0,U.readFileSync)((0,d.join)(process.cwd(),l,".yippie.json")),C=JSON.parse(T.toString()),{LogResult:Y,Payload:j}=await i.invoke({FunctionName:Z,LogType:"Tail",Payload:JSON.stringify(v(w({},C),{username:a,bucketName:D,zipFileName:`${l}.zip`}))}).promise();K&&console.log(Buffer.from(Y,"base64").toString("utf-8")),console.log("Done!");let y=JSON.parse(j.toString());console.log(`Project ID: ${y.projectId}`),console.log(`Production URL: ${y.productionUrl}`)}catch(c){console.error(c.message),process.exit(1)}})}});
