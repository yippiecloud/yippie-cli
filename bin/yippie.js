#!/usr/bin/env node
var z=Object.create;var l=Object.defineProperty,F=Object.defineProperties,_=Object.getOwnPropertyDescriptor,k=Object.getOwnPropertyDescriptors,A=Object.getOwnPropertyNames,v=Object.getOwnPropertySymbols,R=Object.getPrototypeOf,U=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable;var S=(e,o,n)=>o in e?l(e,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[o]=n,u=(e,o)=>{for(var n in o||(o={}))U.call(o,n)&&S(e,n,o[n]);if(v)for(var n of v(o))$.call(o,n)&&S(e,n,o[n]);return e},y=(e,o)=>F(e,k(o)),B=e=>l(e,"__esModule",{value:!0});var x=(e,o,n)=>{if(o&&typeof o=="object"||typeof o=="function")for(let i of A(o))!U.call(e,i)&&i!=="default"&&l(e,i,{get:()=>o[i],enumerable:!(n=_(o,i))||n.enumerable});return e},s=e=>x(B(l(e!=null?z(R(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e);var d=s(require("path")),b=s(require("dotenv")),m=s(require("fs")),t=s(require("aws-sdk")),r=s(require("amazon-cognito-identity-js")),f=s(require("command-line-args")),h=s(require("command-line-usage")),D=s(require("adm-zip"));var E="1.0.15";var I=[{name:"folder",alias:"f",type:String,defaultOption:!0,description:"Folder to deploy."},{name:"username",alias:"u",type:String,description:"Your yippie cloud username."},{name:"password",alias:"p",type:String,description:"Your yippie cloud password."},{name:"help",alias:"h",type:Boolean,description:"Display this usage guide."},{name:"verbose",alias:"v",type:Boolean,description:"Enable verbose outputs."}],P=(0,f.default)(I);if(P.help){let e=(0,h.default)([{header:"Usage",content:"yippie example"},{header:"Options",optionList:I},{content:"Project home: {underline https://www.yippie.cloud}"}]);console.log(e)}var{folder:a,verbose:K=!1}=(0,f.default)(I),M="5brts50g06t59npkbv8t3r2tva",L="yippiecloud-artifacts",O="eu-central-1",W="eu-central-1:b149ff98-8ae0-4157-b245-de1a8f8c2461",N="eu-central-1_zHXNt56dU",Z="yippiecloud-artifact-deployment-function";(0,b.config)();var c=process.env.YIPPIE_USERNAME||P.username,T=process.env.YIPPIE_PASSWORD||P.password;c||(console.error("Username is missing"),process.exit(1));T||(console.error("Password is missing"),process.exit(1));var G=new r.CognitoUserPool({ClientId:M,UserPoolId:N}),q=new r.CognitoUser({Pool:G,Username:c}),H=new r.AuthenticationDetails({Username:c,Password:T});q.authenticateUser(H,{onFailure:e=>{console.error(e.message)},onSuccess:e=>{t.default.config.update({maxRetries:0,httpOptions:{timeout:6e6,connectTimeout:6e6},region:O,credentials:new t.default.CognitoIdentityCredentials({IdentityPoolId:W,Logins:{[`cognito-idp.${O}.amazonaws.com/${N}`]:e.getIdToken().getJwtToken()}})}),t.default.config.credentials.refresh(async o=>{if(console.log(`Yippie cloud CLI v${E}`),o)return console.error(o.message);console.log("Login successfully!");let n=new t.default.S3,i=new t.default.Lambda;try{console.log("Zipping file(s) ...");let p=new D.default;p.addLocalFolder((0,d.join)(process.cwd(),a)),console.log("Uploading file ..."),await n.upload({Bucket:L,Key:`${c}/${a}.zip`,Body:p.toBuffer()}).promise(),console.log("Deploying project (up to 5 minutes) ...");let C=(0,m.readFileSync)((0,d.join)(process.cwd(),a,".yippie.json")),w=JSON.parse(C.toString()),{LogResult:Y,Payload:j}=await i.invoke({FunctionName:Z,LogType:"Tail",Payload:JSON.stringify(y(u({},w),{username:c,bucketName:L,zipFileName:`${a}-${Date.now()}.zip`}))}).promise();K&&console.log(Buffer.from(Y,"base64").toString("utf-8"));let g=JSON.parse(j.toString());console.log("Updating config file ..."),(0,m.writeFileSync)((0,d.join)(process.cwd(),a,".yippie.json"),JSON.stringify(y(u({},w),{id:g.projectId,productionUrl:g.productionUrl}),null,4)),console.log(`Production URL: ${g.productionUrl}`),console.log("Done!")}catch(p){console.error(p.message),process.exit(1)}})}});
